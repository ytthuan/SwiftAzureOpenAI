name: Nightly Code Generation (Enhanced)

on:
  schedule:
    - cron: "0 2 * * *"   # 02:00 UTC nightly
  workflow_dispatch:
    inputs:
      force_regeneration:
        description: "Force regeneration even if spec hash unchanged"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: nightly-codegen
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

env:
  SPEC_URL: https://raw.githubusercontent.com/Azure/azure-rest-api-specs/main/specification/ai/data-plane/OpenAI.v1/azure-v1-v1-generated.json
  GENERATED_FILE: Sources/SwiftAzureOpenAI/Generated/GeneratedModels.swift
  MODULE_NAME: SwiftAzureOpenAI

jobs:
  nightly-codegen:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Swift dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6-dev libicu-dev libcurl4-openssl-dev libssl-dev curl jq

      - name: Install Swift
        run: |
          # Download and install Swift 6.0.2 from Swift.org (matching CI workflow)
          SWIFT_VERSION="6.0.2"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz"
          
          echo "Installing Swift ${SWIFT_VERSION} from ${SWIFT_URL}"
          
          # Download Swift to /tmp to prevent accidental commits
          cd /tmp
          curl -fsSL "${SWIFT_URL}" -o swift.tar.gz
          
          # Extract Swift
          sudo tar -xzf swift.tar.gz -C /opt/
          
          # Clean up tarball immediately to prevent accidental commits
          rm -f swift.tar.gz
          
          # Return to workspace
          cd "${GITHUB_WORKSPACE}"
          
          # Add to PATH
          echo "/opt/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04/usr/bin" >> $GITHUB_PATH
          
          # Verify installation
          /opt/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04/usr/bin/swift --version
          
          echo "‚úÖ Swift ${SWIFT_VERSION} installed successfully"

      - name: Show Swift version
        run: swift --version

      - name: Prepare directories
        run: |
          mkdir -p Specs
          mkdir -p symbolgraph/before symbolgraph/after
          mkdir -p docs
          mkdir -p Reports

      - name: Download current upstream spec
        id: fetch-spec
        run: |
          curl -sSL "$SPEC_URL" -o Specs/current-openapi.json
          if [ ! -s Specs/current-openapi.json ]; then
            echo "‚ùå Spec download failed or empty."
            exit 1
          fi
          
          # Check spec file size (warn if > 1MB)
          SPEC_SIZE=$(wc -c < Specs/current-openapi.json)
          echo "spec_size=$SPEC_SIZE" >> $GITHUB_OUTPUT
          
          if [ "$SPEC_SIZE" -gt 1048576 ]; then
            echo "‚ö†Ô∏è Warning: Spec file is larger than 1MB (${SPEC_SIZE} bytes)"
            echo "This may cause issues with Git pushes"
          fi
          
          sha=$(sha256sum Specs/current-openapi.json | awk '{print $1}')
          echo "spec_sha=$sha" >> $GITHUB_OUTPUT
          echo "‚úÖ Downloaded spec SHA: $sha (size: ${SPEC_SIZE} bytes)"

      - name: Detect previous spec hash
        id: prev-spec
        run: |
          if [ -f Specs/full-openapi.json ]; then
            old_sha=$(sha256sum Specs/full-openapi.json | awk '{print $1}')
            echo "prev_spec_sha=$old_sha" >> $GITHUB_OUTPUT
            echo "Previous spec SHA: $old_sha"
          else
            echo "prev_spec_sha=none" >> $GITHUB_OUTPUT
            echo "No previous stored spec."
          fi

      - name: Decide if spec changed
        id: spec-change
        run: |
          FORCE="${{ github.event.inputs.force_regeneration }}"
          NEW_SHA="${{ steps.fetch-spec.outputs.spec_sha }}"
          OLD_SHA="${{ steps.prev-spec.outputs.prev_spec_sha }}"
          if [ "$FORCE" = "true" ]; then
            echo "force=true" >> $GITHUB_OUTPUT
            echo "Spec marked as changed (forced)."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            if [ "$OLD_SHA" = "none" ] || [ "$NEW_SHA" != "$OLD_SHA" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "Spec content changed."
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "Spec unchanged."
            fi
          fi

      - name: Build (baseline) + capture public API (before)
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          echo "üî® Building baseline (before regeneration)..."
          if ! swift build 2>&1 | tee build-before.log; then
            echo "‚ùå Baseline build failed"
            echo "Build log:"
            tail -50 build-before.log
            exit 1
          fi
          echo "‚úÖ Baseline build successful"
          
          # Create a simple public API snapshot by extracting public declarations
          grep -r "^public " Sources/SwiftAzureOpenAI/ | sort > symbolgraph/before/public-api.txt || echo "// No public API found" > symbolgraph/before/public-api.txt

      - name: Backup current generated models
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          if [ -f "$GENERATED_FILE" ]; then
            cp "$GENERATED_FILE" "$GENERATED_FILE.before"
          else
            echo "// Empty baseline" > "$GENERATED_FILE.before"
          fi

      - name: Update stored spec (always commit spec change even if no model diff later)
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          cp Specs/current-openapi.json Specs/full-openapi.json

      - name: Prune + regenerate models
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          echo "üîç Pruning OpenAPI spec..."
          if ! python3 Scripts/prune-openapi-spec.py; then
            echo "‚ùå Spec pruning failed"
            exit 1
          fi
          echo "‚úÖ Spec pruning successful"
          
          # Check pruned spec size
          if [ -f Specs/pruned-openapi.json ]; then
            PRUNED_SIZE=$(wc -c < Specs/pruned-openapi.json)
            echo "Pruned spec size: ${PRUNED_SIZE} bytes"
          fi
          
          echo "üî® Regenerating Swift models..."
          if ! python3 Scripts/generate-swift-models.py 2>&1 | tee codegen.log; then
            echo "‚ùå Model generation failed"
            echo "Generation log:"
            cat codegen.log
            exit 1
          fi
          echo "‚úÖ Model generation successful"
          
          if [ ! -f "$GENERATED_FILE" ]; then
            echo "‚ùå Generated file missing after generation: $GENERATED_FILE"
            exit 1
          fi
          
          # Show generation stats
          echo "Generated file size: $(wc -c < $GENERATED_FILE) bytes"
          echo "Generated enums: $(grep -c 'public enum' $GENERATED_FILE || echo 0)"
          echo "Generated structs: $(grep -c 'public struct' $GENERATED_FILE || echo 0)"

      - name: Build with new models
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          echo "üî® Building with newly generated models..."
          if ! swift build 2>&1 | tee build-after.log; then
            echo "‚ùå Build with new models failed"
            echo "Build log (last 100 lines):"
            tail -100 build-after.log
            echo ""
            echo "Checking for common issues in generated models..."
            if grep -n "error:" build-after.log; then
              echo "Found compilation errors above"
            fi
            exit 1
          fi
          echo "‚úÖ Build with new models successful"

      - name: Run test suite
        if: steps.spec-change.outputs.changed == 'true'
        timeout-minutes: 10
        continue-on-error: true
        run: |
          echo "üß™ Running test suite..."
          if ! swift test --parallel 2>&1 | tee test.log; then
            echo "‚ùå Test suite failed"
            echo "Test log (last 100 lines):"
            tail -100 test.log
            echo ""
            echo "‚ö†Ô∏è Note: Test failure is non-blocking"
            echo "Tests may fail due to API credentials or network issues"
            exit 0
          else
            echo "‚úÖ All tests passed"
          fi

      - name: Capture public API (after)
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          # Create a simple public API snapshot by extracting public declarations
          grep -r "^public " Sources/SwiftAzureOpenAI/ | sort > symbolgraph/after/public-api.txt || echo "// No public API found" > symbolgraph/after/public-api.txt

      - name: Determine model file diff
        if: steps.spec-change.outputs.changed == 'true'
        id: model-diff
        run: |
          if diff -q "$GENERATED_FILE.before" "$GENERATED_FILE" >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No model file diff."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Model file changed."
          fi

      - name: Classify semantic changes
        if: steps.spec-change.outputs.changed == 'true'
        id: classify
        run: |
          python3 Scripts/classify-model-changes.py \
            --old "$GENERATED_FILE.before" \
            --new "$GENERATED_FILE" \
            --out Reports/model-changes.md \
            --json Reports/model-changes.json \
            --model-changed "${{ steps.model-diff.outputs.changed }}"
          SEMVER=$(jq -r '.semver' Reports/model-changes.json)
          echo "semver_label=semver:${SEMVER}" >> $GITHUB_OUTPUT
          echo "recommended_bump=$SEMVER" >> $GITHUB_OUTPUT

      - name: Public API surface diff (symbolgraph)
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          bash Scripts/diff-symbols.sh symbolgraph/before symbolgraph/after > Reports/symbol-diff.md || echo "Symbol diff script failed." >> Reports/symbol-diff.md

      - name: Compose PR body
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          echo "# Nightly Codegen Report" > Reports/pr-body.md
          echo "" >> Reports/pr-body.md
          echo "**Spec SHA (new):** ${{ steps.fetch-spec.outputs.spec_sha }}" >> Reports/pr-body.md
          echo "**Spec SHA (previous):** ${{ steps.prev-spec.outputs.prev_spec_sha }}" >> Reports/pr-body.md
          echo "**Model file changed:** ${{ steps.model-diff.outputs.changed }}" >> Reports/pr-body.md
          echo "**Recommended semantic version bump:** ${{ steps.classify.outputs.recommended_bump }}" >> Reports/pr-body.md
          echo "" >> Reports/pr-body.md
          if [ -f Reports/model-changes.md ]; then
            echo "## Model Changes" >> Reports/pr-body.md
            cat Reports/model-changes.md >> Reports/pr-body.md
            echo "" >> Reports/pr-body.md
          fi
          if [ -f Reports/symbol-diff.md ]; then
            echo "## Public API Symbol Diff" >> Reports/pr-body.md
            cat Reports/symbol-diff.md >> Reports/pr-body.md
            echo "" >> Reports/pr-body.md
          fi
          echo "## Next Steps" >> Reports/pr-body.md
          echo "1. Review semantic classification & added/removed types." >> Reports/pr-body.md
          echo "2. Confirm no unintended breaking changes." >> Reports/pr-body.md
          echo "3. Update docs/examples if new features added." >> Reports/pr-body.md
          echo "4. Merge and then decide on release pipeline trigger." >> Reports/pr-body.md

      - name: Update CHANGELOG_PENDING
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          ts=$(date -u +"%Y-%m-%d")
          bump=${{ steps.classify.outputs.recommended_bump }}
          {
            echo "### $ts (auto-detected: $bump)"
            echo "- Nightly codegen update. Spec SHA: ${{ steps.fetch-spec.outputs.spec_sha }}"
            if [ "${{ steps.model-diff.outputs.changed }}" = "true" ]; then
              echo "- Model changes detected (see PR body for detail)."
            else
              echo "- Spec changed but generated models unaffected."
            fi
            echo ""
          } >> docs/CHANGELOG_PENDING.md

      - name: Cleanup artifacts before commit
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          echo "üßπ Cleaning up build artifacts and temporary files..."
          
          # Remove any Swift tarballs or extracted directories
          rm -f *.tar.gz *.gz *.zip
          rm -rf swift-*-RELEASE-*/ || true
          
          # Remove build logs
          rm -f build-before.log build-after.log codegen.log test.log
          
          # Remove temporary spec file
          rm -f Specs/current-openapi.json
          
          # Remove backup files created during generation
          rm -f "$GENERATED_FILE.before" "$GENERATED_FILE.backup"
          
          # List what will be committed
          echo "Files to be committed:"
          git status --short
          
          # Check for any large files (> 500KB) that shouldn't be committed
          echo "Checking for large files..."
          LARGE_FILES=$(find . -type f -size +500k -not -path "./.git/*" -not -path "./.build/*")
          if [ -n "$LARGE_FILES" ]; then
            echo "‚ö†Ô∏è Warning: Found large files that may need review:"
            echo "$LARGE_FILES"
          else
            echo "‚úÖ No large files found"
          fi

      - name: Commit spec (always when spec changed)
        if: steps.spec-change.outputs.changed == 'true'
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          echo "üìù Staging files for commit..."
          
          # Always add spec files when changed
          git add Specs/full-openapi.json Specs/pruned-openapi.json || true
          
          # Add changelog
          git add docs/CHANGELOG_PENDING.md || true
          
          # Add generated models if they changed
          if [ "${{ steps.model-diff.outputs.changed }}" = "true" ]; then
            echo "Adding generated models (changed)"
            git add "$GENERATED_FILE"
          fi
          
          # Show what's being committed
          echo "Files staged for commit:"
          git diff --cached --name-only
          echo ""
          echo "Commit size breakdown:"
          git diff --cached --stat
          
          if git diff --cached --quiet; then
            echo "‚úÖ Nothing to commit (no changes detected)"
          else
            # Determine commit message
            msg="codegen: nightly spec sync"
            if [ "${{ steps.model-diff.outputs.changed }}" = "true" ]; then
              msg="$msg + regenerated models"
            else
              msg="$msg (no model diff)"
            fi
            
            echo "Committing with message: $msg"
            git commit -m "$msg"
            echo "‚úÖ Changes committed successfully"
          fi

      # Create Pull Request
      # Note: Uses PAT_TOKEN if available, falls back to GITHUB_TOKEN
      # PAT_TOKEN is required when GitHub Actions is not permitted to create PRs
      # To configure: Settings > Secrets and variables > Actions > New repository secret
      # Name: PAT_TOKEN, Value: Personal Access Token with repo scope
      - name: Create Pull Request (only if something committed)
        if: steps.spec-change.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "codegen: nightly spec sync"
          title: "ü§ñ Nightly Codegen: Spec sync (${{ steps.classify.outputs.recommended_bump }})"
          body-path: Reports/pr-body.md
          branch: codegen/auto-update-models
          delete-branch: true
          labels: |
            codegen
            automated
            ${{ steps.classify.outputs.semver_label }}

      - name: Final status
        run: |
          if [ "${{ steps.spec-change.outputs.changed }}" = "true" ]; then
            echo "Nightly codegen run completed (spec changed)."
          else
            echo "Spec unchanged. Nothing to do."
          fi